image: maven:3.8.5-openjdk-17

stages:
  - build
  - test
  - coverage
  - deploy

init-submodules:
  stage: build
  script:
    - echo "Inicializando submódulos do Git..."
    - git submodule init
    - git submodule update
    - echo "Submódulos inicializados."

install-submodules:
  stage: build
  needs: [init-submodules]
  script:
    - echo "Instalando dependências dos submódulos no Maven local..."
    - cd commons-module && mvn clean install && cd ..
    - cd account-module && mvn clean install && cd ..
    - cd credit-card-module && mvn clean install && cd ..
    - echo "Instalação dos submódulos concluída."

build-job:
  stage: build
  needs: [install-submodules]
  script:
    - echo "Compilando o código com Maven..."
    - mvn clean compile
    - echo "Compilação concluída."
  artifacts:
    paths:
      - target/

lint-test-job:
  stage: test
  needs: [build-job]
  script:
    - echo "Executando análise estática de código (linter)..."
    - mvn checkstyle:check
    - echo "Análise de lint concluída."
  allow_failure: true

unit-test-job:
  stage: test
  needs: [build-job]
  script:
    - echo "Executando testes unitários com Maven..."
    - mvn test
    - echo "Testes unitários concluídos."
  artifacts:
    paths:
      - target/surefire-reports/

coverage-job:
  stage: coverage
  needs: [unit-test-job]
  script:
    - echo "Gerando relatório de cobertura de código com Maven..."
    - mvn clean verify jacoco:report
    - echo "Relatório de cobertura gerado."
  artifacts:
    paths:
      - target/site/jacoco/

deploy-job:
  stage: deploy
  environment: production
  needs: [coverage-job]
  script:
    - echo "Realizando deploy da aplicação..."
    - mvn clean package
    - echo "Aplicação empacotada e pronta para deploy."
