image: maven:3.8.5-openjdk-17

stages:
  - build
  - test
  - coverage
  - deploy

init-submodules:
  stage: build
  script:
    - echo "Initializing Git submodules..."
    - git submodule init
    - git submodule update
    - echo "Git submodules initialized."

install-submodules:
  stage: build
  needs: [init-submodules]
  script:
    - echo "Installing Maven dependencies for each submodule..."
    - cd commons-module && mvn clean install && cd ..
    - cd account-module && mvn clean install && cd ..
    - cd credit-card-module && mvn clean install && cd ..
    - echo "Submodules installed successfully in local Maven repository."

build-job:
  stage: build
  needs: [install-submodules]
  script:
    - echo "Building the loans-module with Maven..."
    - mvn clean compile
    - echo "Build completed."
  artifacts:
    paths:
      - target/

lint-test-job:
  stage: test
  needs: [build-job]
  script:
    - echo "Running static code analysis (linter)..."
    - mvn checkstyle:check
    - echo "Lint analysis completed."
  allow_failure: true

unit-test-job:
  stage: test
  needs: [build-job]
  script:
    - echo "Running unit tests with Maven..."
    - mvn test
    - echo "Unit tests completed."
  artifacts:
    paths:
      - target/surefire-reports/

coverage-job:
  stage: coverage
  needs: [unit-test-job]
  script:
    - echo "Generating code coverage report with Maven..."
    - mvn clean verify jacoco:report
    - echo "Coverage report generated."
  artifacts:
    paths:
      - target/site/jacoco/

deploy-job:
  stage: deploy
  environment: production
  needs: [coverage-job]
  script:
    - echo "Deploying application..."
    - mvn clean package
    - echo "Application packaged and ready for deployment."
